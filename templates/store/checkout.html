{% extends 'base.html' %}

{% load static %}

{% block content %}
<section class="section-content padding-y bg">
<div class="container">

<!-- ============================ COMPONENT 1 ================================= -->

<div class="row">
	<aside class="col-lg-6"> {# Billing and Shipping in one column #}

    <div class="card">
        <div class="card-body">
            <h4 class="card-title mb-4">Billing Address</h4>
            <form id="billingForm" action="{% url 'place_order' %}" method="POST">
                {% csrf_token %}
                {# Billing fields with IDs for JS #}
                <div class="form-row">
                    <div class="col form-group">
                        <label for="first_name">First Name</label>
                        <input type="text" name="first_name" id="first_name" class="form-control" required>
                    </div>
                    <div class="col form-group">
                        <label for="last_name">Last Name</label>
                        <input type="text" name="last_name" id="last_name" class="form-control" required>
                    </div>
                </div>
                <div class="form-row">
                    <div class="col form-group">
                        <label for="email">Email</label>
                        <input type="email" name="email" id="email" class="form-control" required>
                    </div>
                    <div class="col form-group">
                        <label for="phone">Phone Number</label>
                        <input type="text" name="phone" id="phone" class="form-control" required maxlength="12">  <!-- Maxlength for 10 digits + 2 dashes -->
                    </div>
                </div>
                <div class="form-row">
                    <div class="col form-group">
                        <label for="address_line_1">Address Line 1</label>
                        <input type="text" name="address_line_1" id="address_line_1" class="form-control" required>
                    </div>
                    <div class="col form-group">
                        <label for="address_line_2">Address Line 2</label>
                        <input type="text" name="address_line_2" id="address_line_2" class="form-control">
                    </div>
                </div>
                <div class="form-row">
                    <div class="col form-group">
                        <label for="city">City</label>
                        <input type="text" name="city" id="city" class="form-control" required>
                    </div>
                    <div class="col form-group">
                        <label for="state">State</label>
                        <!-- NEW: State Dropdown (lower 48 only) -->
                        <select name="state" id="state" class="form-control" required>
                            <option value="" disabled selected>Select State</option>
                            <option value="AL">Alabama</option>
                            <option value="AZ">Arizona</option>
                            <option value="AR">Arkansas</option>
                            <option value="CA">California</option>
                            <option value="CO">Colorado</option>
                            <option value="CT">Connecticut</option>
                            <option value="DE">Delaware</option>
                            <option value="FL">Florida</option>
                            <option value="GA">Georgia</option>
                            <option value="ID">Idaho</option>
                            <option value="IL">Illinois</option>
                            <option value="IN">Indiana</option>
                            <option value="IA">Iowa</option>
                            <option value="KS">Kansas</option>
                            <option value="KY">Kentucky</option>
                            <option value="LA">Louisiana</option>
                            <option value="ME">Maine</option>
                            <option value="MD">Maryland</option>
                            <option value="MA">Massachusetts</option>
                            <option value="MI">Michigan</option>
                            <option value="MN">Minnesota</option>
                            <option value="MS">Mississippi</option>
                            <option value="MO">Missouri</option>
                            <option value="MT">Montana</option>
                            <option value="NE">Nebraska</option>
                            <option value="NV">Nevada</option>
                            <option value="NH">New Hampshire</option>
                            <option value="NJ">New Jersey</option>
                            <option value="NM">New Mexico</option>
                            <option value="NY">New York</option>
                            <option value="NC">North Carolina</option>
                            <option value="ND">North Dakota</option>
                            <option value="OH">Ohio</option>
                            <option value="OK">Oklahoma</option>
                            <option value="OR">Oregon</option>
                            <option value="PA">Pennsylvania</option>
                            <option value="RI">Rhode Island</option>
                            <option value="SC">South Carolina</option>
                            <option value="SD">South Dakota</option>
                            <option value="TN">Tennessee</option>
                            <option value="TX">Texas</option>
                            <option value="UT">Utah</option>
                            <option value="VT">Vermont</option>
                            <option value="VA">Virginia</option>
                            <option value="WA">Washington</option>
                            <option value="WV">West Virginia</option>
                            <option value="WI">Wisconsin</option>
                            <option value="WY">Wyoming</option>
                        </select>
                    </div>
                </div>
                <div class="form-row">
                    <div class="col form-group">
                        <label for="country">Country</label>
                        <select name="country" id="country" class="form-control" required>
                            <option value="US" selected>United States</option>
                        </select>
                    </div>
                    <div class="col form-group">
                        <label for="zip_code">Zip Code</label>
                        <input type="text" name="zip_code" id="zip_code" class="form-control" required>
                    </div>
                </div>
                <div class="form-group">
                    <label for="order_note">Order Note</label>
                    <textarea name="order_note" id="order_note" rows="2" class="form-control"></textarea>
                </div>

                {# Shipping Address Section #}
                <h4 class="card-title mb-4 mt-5">Shipping Address</h4>
                <div class="form-group">
                    <input type="checkbox" id="sameAsBilling">
                    <label for="sameAsBilling">Shipping address is the same as billing</label>
                </div>
                <div class="form-row">
                    <div class="col form-group">
                        <label for="shipping_first_name">First Name</label>
                        <input type="text" name="shipping_first_name" id="shipping_first_name" class="form-control" required>
                    </div>
                    <div class="col form-group">
                        <label for="shipping_last_name">Last Name</label>
                        <input type="text" name="shipping_last_name" id="shipping_last_name" class="form-control" required>
                    </div>
                </div>
                <div class="form-row">
                    <div class="col form-group">
                        <label for="shipping_email">Email</label>
                        <input type="email" name="shipping_email" id="shipping_email" class="form-control" required>
                    </div>
                    <div class="col form-group">
                        <label for="shipping_phone">Phone Number</label>
                        <input type="text" name="shipping_phone" id="shipping_phone" class="form-control" required maxlength="12">  <!-- Maxlength for 10 digits + 2 dashes -->
                    </div>
                </div>
                <div class="form-row">
                    <div class="col form-group">
                        <label for="shipping_address_line_1">Address Line 1</label>
                        <input type="text" name="shipping_address_line_1" id="shipping_address_line_1" class="form-control" required>
                    </div>
                    <div class="col form-group">
                        <label for="shipping_address_line_2">Address Line 2</label>
                        <input type="text" name="shipping_address_line_2" id="shipping_address_line_2" class="form-control">
                    </div>
                </div>
                <div class="form-row">
                    <div class="col form-group">
                        <label for="shipping_city">City</label>
                        <input type="text" name="shipping_city" id="shipping_city" class="form-control" required>
                    </div>
                    <div class="col form-group">
                        <label for="shipping_state">State</label>
                        <!-- NEW: Shipping State Dropdown (lower 48 only) -->
                        <select name="shipping_state" id="shipping_state" class="form-control" required>
                            <option value="" disabled selected>Select State</option>
                            <option value="AL">Alabama</option>
                            <option value="AZ">Arizona</option>
                            <option value="AR">Arkansas</option>
                            <option value="CA">California</option>
                            <option value="CO">Colorado</option>
                            <option value="CT">Connecticut</option>
                            <option value="DE">Delaware</option>
                            <option value="FL">Florida</option>
                            <option value="GA">Georgia</option>
                            <option value="ID">Idaho</option>
                            <option value="IL">Illinois</option>
                            <option value="IN">Indiana</option>
                            <option value="IA">Iowa</option>
                            <option value="KS">Kansas</option>
                            <option value="KY">Kentucky</option>
                            <option value="LA">Louisiana</option>
                            <option value="ME">Maine</option>
                            <option value="MD">Maryland</option>
                            <option value="MA">Massachusetts</option>
                            <option value="MI">Michigan</option>
                            <option value="MN">Minnesota</option>
                            <option value="MS">Mississippi</option>
                            <option value="MO">Missouri</option>
                            <option value="MT">Montana</option>
                            <option value="NE">Nebraska</option>
                            <option value="NV">Nevada</option>
                            <option value="NH">New Hampshire</option>
                            <option value="NJ">New Jersey</option>
                            <option value="NM">New Mexico</option>
                            <option value="NY">New York</option>
                            <option value="NC">North Carolina</option>
                            <option value="ND">North Dakota</option>
                            <option value="OH">Ohio</option>
                            <option value="OK">Oklahoma</option>
                            <option value="OR">Oregon</option>
                            <option value="PA">Pennsylvania</option>
                            <option value="RI">Rhode Island</option>
                            <option value="SC">South Carolina</option>
                            <option value="SD">South Dakota</option>
                            <option value="TN">Tennessee</option>
                            <option value="TX">Texas</option>
                            <option value="UT">Utah</option>
                            <option value="VT">Vermont</option>
                            <option value="VA">Virginia</option>
                            <option value="WA">Washington</option>
                            <option value="WV">West Virginia</option>
                            <option value="WI">Wisconsin</option>
                            <option value="WY">Wyoming</option>
                        </select>
                    </div>
                </div>
                <div class="form-row">
                    <div class="col form-group">
                        <label for="shipping_country">Country</label>
                        <select name="shipping_country" id="shipping_country" class="form-control" required>
                            <option value="US" selected>United States</option>
                        </select>
                    </div>
                    <div class="col form-group">
                        <label for="shipping_zip_code">Zip Code</label>
                        <input type="text" name="shipping_zip_code" id="shipping_zip_code" class="form-control" required>
                    </div>
                </div>
            </form> {# End of the combined form #}
        </div> {# card-body #}
    </div> {# card #}

</aside> <!-- col.// --> <!-- col.// --> <!-- col.// -->
	<aside class="col-lg-6"> {# Cart summary now takes 6 out of 12 columns for balanced layout and price column space #}

		<div class="card">
		<div class="card-body">

            <a href="{% url 'cart' %}" class="btn btn-light btn-block mb-3">Edit Cart</a> {# Changed to btn-light for white #}

            <table class="table table-borderless table-shopping-cart">
            <thead class="text-muted">
            <tr class="small text-uppercase">
              <th scope="col">Product</th>
              <th scope="col">Quantity</th>
              <th scope="col">Price</th>
              <th scope="col" class="text-right"> </th>
            </tr>
            </thead>
            <tbody>

            {% for cart_item in cart_items %}

            <tr id="cart-item-{{ cart_item.id }}">
                <td>
                    <figure class="itemside align-items-center">
                        <div class="aside"><img src="{{ cart_item.product.images.url }}" class="img-sm"></div>
                        <figcaption class="info">
                            <a href="{{ cart_item.product.get_url }}" class="title text-dark">{{ cart_item.product.product_name }}</a>
                            <p class="text-muted small">
                                {% if cart_item.variations.all %}
                                    {% for item in cart_item.variations.all %}
                                        {{ item.variation_category | capfirst }} : {{ item.variation_value | capfirst }}<br>
                                    {% endfor %}
                                {% endif %}
                            </p>
                        </figcaption>
                    </figure>
                </td>
                <td>
                    {# STATIC QUANTITY DISPLAY - NO BUTTONS #}
                    <div class="text-center">
                        <span class="b text-muted">{{ cart_item.quantity }}</span>
                    </div>
                </td>
                <td>
                    <div class="price-wrap">
                        <var class="price item-subtotal" id="item-subtotal-{{ cart_item.id }}">$ {{ cart_item.sub_total|floatformat:2 }}</var>  {# UPDATED: Added |floatformat:2 #}
                        <small class="text-muted">$ {{ cart_item.product.price|floatformat:2 }} each </small>  {# UPDATED: Added |floatformat:2 #}
                    </div> <!-- price-wrap .// -->
                </td>

            </tr>

            {% endfor %}

            </tbody>
            </table>
            <dl class="dlist-align">
              <dt>Total price:</dt>
              <dd class="text-right" id="cart-total">${{ total|floatformat:2 }}</dd>  {# UPDATED: Added |floatformat:2 #}
            </dl>
            <dl class="dlist-align">
              <dt>Tax:</dt>
              <dd class="text-right" id="cart-tax"> ${{ tax|floatformat:2 }}</dd>  {# UPDATED: Added |floatformat:2 #}
            </dl>
            <dl class="dlist-align">
              <dt>Grand Total:</dt>
              <dd class="text-right text-dark b" id="cart-grand-total"><strong>${{ grand_total|floatformat:2 }}</strong></dd>  {# UPDATED: Added |floatformat:2 #}
            </dl>
            <hr>
            <p class="text-center mb-3">
                <img src="{% static './images/misc/payments.png' %}" height="26">
            </p>
            <!-- UPDATED: Payment Option Buttons (both submit the form and trigger the same PayPal flow) -->
            <button type="submit" form="billingForm" name="submit" class="btn btn-secondary btn-block mb-2">Pay with Credit Card </button>
            <button type="submit" form="billingForm" name="submit" class="btn btn-primary btn-block mb-2">Pay with PayPal</button>
            <p class="text-muted small text-center">You'll be redirected to PayPal to complete your payment securely (credit card option available as guest checkout).</p>
            <a href="{% url 'store' %}" class="btn btn-light btn-block">Continue Shopping</a>
		</div> <!-- card-body.// -->
		</div> <!-- card.// -->

</aside> <!-- col.// -->


</div> <!-- row.// -->
<!-- ============================ COMPONENT 1 END .// ================================= -->

</div> <!-- container .//  -->
</section>
<!-- ========================= SECTION CONTENT END// ========================= -->

{% endblock %}

{% block scripts %}
<script>
    function copyBillingToShipping() {
        var checkbox = document.getElementById('sameAsBilling');
        if (checkbox && checkbox.checked) {
            var fields = [
                {billing: 'first_name', shipping: 'shipping_first_name'},
                {billing: 'last_name', shipping: 'shipping_last_name'},
                {billing: 'email', shipping: 'shipping_email'},
                {billing: 'phone', shipping: 'shipping_phone'},
                {billing: 'address_line_1', shipping: 'shipping_address_line_1'},
                {billing: 'address_line_2', shipping: 'shipping_address_line_2'},
                {billing: 'city', shipping: 'shipping_city'},
                {billing: 'state', shipping: 'shipping_state'},  // NEW: Copies state dropdown value
                {billing: 'country', shipping: 'shipping_country'},
                {billing: 'zip_code', shipping: 'shipping_zip_code'}
            ];
            fields.forEach(function(field) {
                var billingElem = document.getElementById(field.billing);
                var shippingElem = document.getElementById(field.shipping);
                if (billingElem && shippingElem) {
                    shippingElem.value = billingElem.value || '';
                }
            });
        } else if (checkbox) {
            var shippingIds = [
                'shipping_first_name', 'shipping_last_name', 'shipping_email', 'shipping_phone',
                'shipping_address_line_1', 'shipping_address_line_2', 'shipping_city',
                'shipping_state', 'shipping_country', 'shipping_zip_code'
            ];
            shippingIds.forEach(function(id) {
                var elem = document.getElementById(id);
                if (elem) {
                    elem.value = '';  // Clear text inputs
                    if (elem.tagName === 'SELECT') {
                        elem.selectedIndex = 0;  // Reset dropdown to first option ("Select State")
                    }
                }
            });
        }
    }

    // NEW: Function to format phone as XXX-XXX-XXXX
    function formatPhone(input) {
        // Strip all non-digits
        let value = input.value.replace(/\D/g, '');
        // Limit to 10 digits
        if (value.length > 10) value = value.substring(0, 10);
        // Add dashes
        if (value.length > 3 && value.length <= 6) {
            value = value.substring(0, 3) + '-' + value.substring(3);
        } else if (value.length > 6) {
            value = value.substring(0, 3) + '-' + value.substring(3, 6) + '-' + value.substring(6);
        }
        input.value = value;
    }

    // NEW: Function to capitalize first letter of each word in city fields
    function capitalizeCity(input) {
        input.value = input.value.replace(/\w\S*/g, function(txt) {
            return txt.charAt(0).toUpperCase() + txt.substr(1).toLowerCase();
        });
    }

    // Wait for DOM to be ready, then attach listeners
    document.addEventListener('DOMContentLoaded', function() {
        var checkbox = document.getElementById('sameAsBilling');
        if (checkbox) {
            checkbox.addEventListener('change', copyBillingToShipping);
        }

        // Add dynamic listeners for billing field changes
        var billingIds = ['first_name', 'last_name', 'email', 'phone', 'address_line_1', 'address_line_2', 'city', 'state', 'country', 'zip_code'];
        billingIds.forEach(function(id) {
            var elem = document.getElementById(id);
            if (elem) {
                elem.addEventListener('input', function() {  // Use 'input' for text/select changes
                    if (document.getElementById('sameAsBilling').checked) {
                        copyBillingToShipping();
                    }
                });
                if (elem.tagName === 'SELECT') {
                    elem.addEventListener('change', function() {  // Extra listener for dropdown changes
                        if (document.getElementById('sameAsBilling').checked) {
                            copyBillingToShipping();
                        }
                    });
                }
            }
        });

        // Attach real-time capitalization to city fields
        var cityFields = ['city', 'shipping_city'];
        cityFields.forEach(function(id) {
            var elem = document.getElementById(id);
            if (elem) {
                elem.addEventListener('input', function() {
                    capitalizeCity(this);  // Capitalize as they type
                });
            }
        });

        // NEW: Attach real-time formatting to phone fields
        var phoneFields = ['phone', 'shipping_phone'];
        phoneFields.forEach(function(id) {
            var elem = document.getElementById(id);
            if (elem) {
                elem.addEventListener('input', function() {
                    formatPhone(this);  // Format as XXX-XXX-XXXX as they type
                });
            }
        });
    });
</script>
{% endblock %}