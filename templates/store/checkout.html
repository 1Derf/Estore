{% extends 'base.html' %}
{% load static %}
{% load static cart_extras %}
{% block content %}
<section class="section-content padding-y bg">
    <div class="container">
        <div class="row">
            <aside class="col-lg-6">
                <div class="card">
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <h4 class="card-title mb-4">Billing Address</h4>
                                <div class="address" style="border: 1px solid #ddd; padding: 8px;">
                                    <p style="margin: 2px 0;">{{ billing_data.first_name }} {{ billing_data.last_name }}</p>
                                    <p style="margin: 2px 0;">{{ billing_data.address_line_1 }} {{ billing_data.address_line_2 }}</p>
                                    <p style="margin: 2px 0;">{{ billing_data.city }}, {{ billing_data.state }} {{ billing_data.zip_code }}</p>
                                    <p style="margin: 2px 0;">{{ billing_data.phone }} | {{ billing_data.email }}</p>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <h4 class="card-title mb-4">Shipping Address</h4>
                                <div class="address" style="border: 1px solid #ddd; padding: 8px;">
                                    <p style="margin: 2px 0;">{{ billing_data.shipping_first_name }} {{ billing_data.shipping_last_name }}</p>
                                    <p style="margin: 2px 0;">{{ billing_data.shipping_address_line_1 }} {{ billing_data.shipping_address_line_2 }}</p>
                                    <p style="margin: 2px 0;">{{ billing_data.shipping_city }}, {{ billing_data.shipping_state }} {{ billing_data.shipping_zip_code }}</p>
                                    <p style="margin: 2px 0;">{{ billing_data.shipping_phone }} | {{ billing_data.shipping_email }}</p>
                                </div>
                            </div>
                        </div>
                        <div class="row mt-4">  <!-- Added row with margin-top for spacing -->
                            <div class="col-md-12">
                                <h4 class="card-title mb-4">Order Notes</h4>
                                <div class="address" style="border: 1px solid #ddd; padding: 8px; margin-bottom: 20px;">
                                    <p style="margin: 2px 0;">{{ billing_data.order_note|default:"None" }}</p>
                                </div>
                            </div>
                        </div>
                        <a href="{% url 'cart' %}" class="btn btn-light btn-block mb-3">Edit Addresses</a>
                    </div>
                </div>
            </aside>

                <aside class="col-lg-6">
                    <div class="card">
                        <div class="card-body">
                            <a href="{% url 'cart' %}" class="btn btn-light btn-block mb-3">Edit Cart</a>
                            <table class="table table-borderless table-shopping-cart">
                                <thead class="text-muted">
                                    <tr class="small text-uppercase">
                                        <th scope="col" style="width:55%">Product</th>
                                        <th scope="col" style="width:15%">Qty</th>
                                        <th scope="col" style="width:20%" class="text-center">Price</th>
                                        <th scope="col" style="width:5%"></th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for cart_item in cart_items %}
                                        <tr id="cart-item-{{ cart_item.id }}">
                                            <td>
                                                <figure class="itemside align-items-center">
                                                    <div class="aside"><img src="{{ cart_item.product.images.url }}" class="img-sm"></div>
                                                    <figcaption class="info">
                                                        <a href="{{ cart_item.product.get_url }}" class="title text-dark">{{ cart_item.product.product_name }}</a>
                                                        <p class="text-muted small">
                                                            {% for item in cart_item.variations.all %}
                                                                {{ item.category.name }} : {{ item.name }}
                                                                {% if item.price_modifier and item.price_modifier > 0 %}
                                                                    (+${{ item.price_modifier }})
                                                                {% endif %}
                                                                <br>
                                                            {% endfor %}
                                                        </p>
                                                    </figcaption>
                                                </figure>
                                            </td>
                                            <td class="text-center">
                                                <span class="b text-muted">{{ cart_item.quantity }}</span>
                                            </td>
                                            <td>
                                                <div class="price-wrap">
                                                    <var class="price">$ {{ cart_item.sub_total|floatformat:2 }}</var>
                                                    <small class="text-muted">$ {{ cart_item.sub_total|divided_by:cart_item.quantity|floatformat:2 }} each</small>
                                                </div>
                                            </td>
                                            <td></td>
                                        </tr>
                                    {% endfor %}
                                </tbody>
                            </table>

                            <dl class="dlist-align">
                                <dt>Subtotal:</dt>
                                <dd class="text-right" id="subtotal-display" data-amount="{{ total|floatformat:2 }}">
                                    ${{ total }}
                                </dd>
                            </dl>
                            <dl class="dlist-align">
                                <dt>Tax:</dt>
                                <dd class="text-right" id="tax-display" data-amount="{{ tax|floatformat:2 }}">
                                    ${{ tax }}
                                </dd>
                            </dl>
                                <dl class="dlist-align" id="shipping-display">
                                    <dt>Shipping:</dt>
                                    <dd>
                                        {% if rates %}
                                            <div id="shipping-options">
                                                {% for rate in rates %}
                                                <div class="form-check">
                                                    <input class="form-check-input shipping-option" type="radio" name="selected_rate" id="rate_{{ forloop.counter }}" value="{{ rate.id }}" data-cost="{{ rate.rate }}" data-carrier="{{ rate.carrier }}" data-service="{{ rate.service }}" {% if forloop.first %}checked{% endif %}>
                                                    <label class="form-check-label" for="rate_{{ forloop.counter }}">
                                                        {% if rate.id == 'rate_free' %}
                                                            Free Shipping (on orders $99+): $0.00
                                                        {% else %}
                                                            {{ rate.carrier }} — {{ rate.service }} (${{ rate.rate|floatformat:2 }})
                                                        {% endif %}
                                                    </label>
                                                </div>
                                                {% endfor %}
                                            </div>
                                        {% else %}
                                            <span class="text-muted">No rates available</span>
                                        {% endif %}
                                    </dd>
                                </dl>
                            <dl class="dlist-align">
                                <dt><strong>Grand Total:</strong></dt>
                                <dd class="text-right text-dark b" id="grand-display">
                                    <strong>${{ total|add:tax }}</strong>
                                </dd>
                            </dl>
                            <hr>
                            <p class="text-center mb-3">
                                <img src="{% static './images/misc/payments.png' %}" height="26">
                            </p>

                                <form id="paymentForm" action="{% url 'place_order' %}" method="POST">
                                    {% csrf_token %}
                                    <input type="hidden" name="selected_rate_id" id="selected_rate_id" value="">
                                </form>

                                <button type="submit" form="paymentForm" class="btn btn-secondary btn-block mb-2">Pay with Credit Card</button>
                                <button type="submit" form="paymentForm" class="btn btn-primary btn-block mb-2">Pay with PayPal</button>

                            <p class="text-muted small text-center">You'll be redirected to PayPal to complete your payment securely.</p>
                            <a href="{% url 'store:store' %}" class="btn btn-light btn-block">Continue Shopping</a>
                        </div>
                    </div>
                </aside>
        </div>
    </div>
</section>
{% endblock %}
{% block scripts %}
<script>
function updateShipping(e) {
  const target = e ? e.target : document.querySelector('.shipping-option:checked');
  if (target) {
    const cost = parseFloat(target.dataset.cost);
    const method = `${target.dataset.carrier} — ${target.dataset.service}`;
    const shippingBox = document.getElementById("shipping-display");
    const grandBox = document.getElementById("grand-display");
    const selectedRateId = target.value;

    document.getElementById("selected_rate_id").value = selectedRateId;

    // Remove or comment out the update shipping line to keep options visible
    // if (selectedRateId === 'rate_free') {
    //   shippingBox.querySelector("dd").innerHTML = `Free Shipping (on orders $99+) — $0.00`;
    // } else {
    //   shippingBox.querySelector("dd").innerHTML = `${method} — $${cost.toFixed(2)}`;
    // }

    // recalc grand total
    const subtotal = parseFloat(document.getElementById("subtotal-display").dataset.amount);
    const tax = parseFloat(document.getElementById("tax-display").dataset.amount);
    const newGrand = (subtotal + tax + cost).toFixed(2);
    grandBox.innerHTML = `<strong>$${newGrand}</strong>`;
  }
}

document.addEventListener("change", function (e) {
  if (e.target.classList.contains("shipping-option")) {
    updateShipping(e);
  }
});

// Run on load for default selection
document.addEventListener("DOMContentLoaded", function () {
  updateShipping();
});
</script>
{% endblock %}

