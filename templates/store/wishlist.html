{% extends 'base.html' %}
{% load static %}

{% block content %}
<section class="section-content padding-y bg">
    <div class="container">
        <h2 class="text-center">My Wishlist</h2>
        {% if wishlist_items %}
            <div class="row">
                {% for item in wishlist_items %}
                    <div class="col-md-4 mb-4">
                        <div class="card">
                            <img src="{{ item.product.images.url }}" class="card-img-top" alt="{{ item.product.product_name }}">
                            <div class="card-body">
                                <h5 class="card-title">{{ item.product.product_name }} (Quantity: {{ item.quantity }})</h5>
                                <p class="card-text">${{ item.product.price|floatformat:2 }}</p>
                                {% if item.variations.all %}
                                    <p class="card-text">
                                        {% for variation in item.variations.all %}
                                            <strong>{{ variation.category.name }}:</strong> {{ variation.name|capfirst }}
                                            {% if not forloop.last %}<br>{% endif %}
                                        {% endfor %}
                                    </p>
                                {% endif %}
                                <a href="{{ item.product.get_url }}" class="btn btn-primary btn-sm">View Details</a>
                                    <button class="btn btn-success btn-sm add-to-cart"
                                            data-product-id="{{ item.product.id }}"
                                            data-quantity="{{ item.quantity }}"
                                            data-variations='[
                                                {% for variation in item.variations.all %}
                                                    {"category": "{{ variation.category.name|escapejs }}", "value": "{{ variation.name|escapejs }}"}
                                                    {% if not forloop.last %},{% endif %}
                                                {% endfor %}
                                            ]'>
                                        Add to Cart
                                    </button>
                                <button class="btn btn-danger btn-sm remove-from-wishlist" data-product-id="{{ item.product.id }}">Remove</button>
                            </div>
                        </div>
                    </div>
                {% endfor %}
            </div>
        {% else %}
            <p class="text-center">Your wishlist is empty. Start adding products!</p>
        {% endif %}
    </div>
</section>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // --- Remove from Wishlist ---
    document.querySelectorAll('.remove-from-wishlist').forEach(button => {
        button.addEventListener('click', () => {
            const productId = button.dataset.productId;

            fetch(`/store/remove_from_wishlist/${productId}/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': '{{ csrf_token }}',
                    'Content-Type': 'application/json',
                    'X-Requested-With': 'XMLHttpRequest'
                }
            })
            .then(r => r.json())
            .then(data => showToast(data.message))
            .finally(() => location.reload());
        });
    });

    // --- Add to Cart from Wishlist ---
    document.querySelectorAll('.add-to-cart').forEach(button => {
        button.addEventListener('click', () => {
            const productId = button.dataset.productId;
            const quantity  = button.dataset.quantity || '1';
            const variations = JSON.parse(button.dataset.variations || '[]');

            const formData = new FormData();
            formData.append('csrfmiddlewaretoken', '{{ csrf_token }}');
            formData.append('quantity', quantity);

            // Use correct field names
            variations.forEach(v => {
                formData.append(v.category, v.value);
            });

            fetch(`/cart/add_cart/${productId}/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': '{{ csrf_token }}',
                    'X-Requested-With': 'XMLHttpRequest'
                },
                body: formData
            })
            .then(async response => {
                const text = await response.text();
                let data = {};
                try { data = JSON.parse(text); } catch {}
                if (!response.ok) {
                    console.warn('Add to cart failed:', data.message || text);
                    return showToast(data.message || 'Failed to add to cart.', true);
                }
                showToast(data.message || 'Added to cart!');
                setTimeout(() => location.reload(), 1200);
            })
            .catch(err => showToast('Network error: ' + err.message, true));
        });
    });

    // --- Small toast helper (no alerts) ---
    function showToast(msg, isError = false) {
        const toast = document.createElement('div');
        toast.textContent = msg;
        toast.style.position = 'fixed';
        toast.style.top = '50%';
        toast.style.left = '50%';
        toast.style.transform = 'translate(-50%, -50%)';
        toast.style.background = isError ? '#dc3545' : '#198754';
        toast.style.color = '#fff';
        toast.style.padding = '0.5rem 1rem';
        toast.style.borderRadius = '5px';
        toast.style.zIndex = 9999;
        toast.style.opacity = '0.95';
        document.body.appendChild(toast);
        setTimeout(() => toast.remove(), 3000);

    }
});
</script>
{% endblock %}