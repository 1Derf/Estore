<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Order Confirmation</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 0; padding: 0; background-color: #f4f4f4; }
        .container { max-width: 600px; margin: 20px auto; background: #ffffff; padding: 20px; border: 1px solid #ddd; }
        h2 { color: #28a745; text-align: center; }
        h3 { font-size: 18px; margin-bottom: 10px; }
        p { margin: 5px 0; }  /* Reduced global margin for tighter spacing */
        .text-center { text-align: center; }
        .text-muted { color: #6c757d; }
        table { width: 100%; border-collapse: collapse; }
        th, td { padding: 10px; }
        thead { background-color: #f8f9fa; }
        .address p { margin: 2px 0; }  /* Specific override for address lines */
    </style>
</head>
<body>
    <div class="container">
        <h2>Order Confirmation!</h2>
        <p class="text-center">Hi {{ user.first_name }},</p>
        <p class="text-center">Thank you for your purchase. Your order number is <strong>{{ order.order_number }}</strong>.</p>
        <p class="text-center text-muted">Your order details are below for reference.</p>

        <table width="100%" cellpadding="0" cellspacing="0" style="border-collapse: collapse; margin-bottom: 20px;">
            <tr>
                <td width="50%" valign="top" style="border: 1px solid #ddd; padding: 8px;" class="address">
                    <h3>Billing Address</h3>
                    <p>{{ order.full_name }}</p>
                    <p>{{ order.full_address }}</p>
                    <p>{{ order.city }}, {{ order.state }} {{ order.zip_code }}</p>
                    <p>{{ order.country }}</p>
                    <p>{{ order.email }}</p>
                    <p>{{ order.phone }}</p>
                    {% if order.order_note %}
                        <p><strong>Order Note:</strong> {{ order.order_note }}</p>
                    {% endif %}
                </td>
                <td width="50%" valign="top" style="border: 1px solid #ddd; padding: 8px;" class="address">
                    <h3>Shipping Address</h3>
                    {% if order.shipping_first_name %}
                        <p>{{ order.shipping_first_name }} {{ order.shipping_last_name }}</p>
                        <p>{{ order.shipping_address_line_1 }}{% if order.shipping_address_line_2 %}, {{ order.shipping_address_line_2 }}{% endif %}</p>
                        <p>{{ order.shipping_city }}, {{ order.shipping_state }} {{ order.shipping_zip_code }}</p>
                        <p>{{ order.shipping_country }}</p>
                        <p>{{ order.shipping_email }}</p>
                        <p>{{ order.shipping_phone }}</p>
                    {% else %}
                        <p>Same as billing address.</p>
                    {% endif %}
                </td>
            </tr>
        </table>

        <h3>Ordered Products</h3>
        <table width="100%" cellpadding="10" cellspacing="0" style="border-collapse: collapse; border: 1px solid #ddd; margin-bottom: 20px;">
            <thead>
                <tr>
                    <th style="text-align: left; border-bottom: 1px solid #ddd;">Product</th>
                    <th style="text-align: center; border-bottom: 1px solid #ddd;">Quantity</th>
                    <th style="text-align: right; border-bottom: 1px solid #ddd;">Price</th>
                </tr>
            </thead>
            <tbody>
                {% for item in ordered_products %}
                <tr>
                    <td style="border-bottom: 1px solid #ddd;">
                        <strong>{{ item.product.product_name }}</strong>
                        {% if item.variations.all %}
                            <br>
                            {% for var in item.variations.all %}
                                {{ var.variation_category|capfirst }}: {{ var.variation_value|capfirst }}<br>
                            {% endfor %}
                        {% endif %}
                    </td>
                    <td style="text-align: center; border-bottom: 1px solid #ddd;">{{ item.quantity }}</td>
                    <td style="text-align: right; border-bottom: 1px solid #ddd;">
                        ${{ item.sub_total|floatformat:2 }}<br>
                        <small style="color: #6c757d;">(${{ item.product_price|floatformat:2 }} each)</small>
                    </td>
                </tr>
                {% empty %}
                <tr><td colspan="3" style="text-align: center;">No products in this order.</td></tr>
                {% endfor %}
            </tbody>
        </table>

        <div style="text-align: right; margin-bottom: 20px;">
            <p><strong>Total Price:</strong> ${{ total|floatformat:2 }}</p>
            <p><strong>Tax:</strong> ${{ tax|floatformat:2 }}</p>
            <p><strong>Grand Total:</strong> ${{ grand_total|floatformat:2 }}</p>
        </div>

        <h3>Payment Method</h3>
        <table width="100%" cellpadding="10" cellspacing="0" style="border-collapse: collapse; border: 1px solid #ddd; margin-bottom: 20px;">
            <tr>
                <td>PayPal</td>
            </tr>
        </table>

        <p class="text-center text-muted">If you have any questions, contact us at support@yourstore.com.</p>
        <p class="text-center">Thank you for shopping with us!</p>
        <p class="text-center text-muted" style="font-size: 12px;">&copy; Your Store Name {% now "Y" %}</p>
    </div>
</body>
</html>